
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Visitor Session 10</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #111; color: white; padding: 20px; text-align: center; }
        input, button { margin: 5px; width: 300px; }
        .desactivado { background-color: #666; }
    </style>
</head>
<body>
    <h2>ðŸŽ¤ Pedir una CanciÃ³n</h2>
    <input type="text" class="form-control" id="nombre" placeholder="Tu nombre" onchange="actualizarNombre()" />
    <input type="text" class="form-control" id="cancion" placeholder="CanciÃ³n" />
    <input type="text" class="form-control" id="artista" placeholder="Artista" />
    <button id="btnAgregar" class="btn btn-primary" onclick="agregarCancion()">Agregar CanciÃ³n</button>
    <p id="estadoTexto" style="color: orange; margin-top: 10px;"></p>

    <script>
        const firebaseConfig = {
            databaseURL: "https://karaokedatabase-c6a7d-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let visitanteId = sessionStorage.getItem("visitanteId");

        if (!visitanteId) {
            db.ref("visitantes").once("value").then(snap => {
                const nuevoId = "visit" + (Object.keys(snap.val() || {}).length + 1);
                visitanteId = nuevoId;
                db.ref("visitantes/" + visitanteId).set({ nombre: "", habilitado: false });
                sessionStorage.setItem("visitanteId", visitanteId);
            });
        }

        function actualizarNombre() {
            const nombre = document.getElementById("nombre").value;
            db.ref("visitantes/" + visitanteId).update({ nombre });
        }

        db.ref("visitantes").on("value", snap => {
            const visitante = snap.val() && snap.val()[visitanteId];
            const btn = document.getElementById("btnAgregar");
            const msg = document.getElementById("estadoTexto");
            if (visitante && visitante.habilitado) {
                btn.disabled = false;
                msg.textContent = "";
            } else {
                btn.disabled = true;
                msg.textContent = "ðŸŽ§ Contacta al DJ para que habilite tu acceso";
            }
        });

        function agregarCancion() {
            const nombre = document.getElementById("nombre").value.trim();
            const cancion = document.getElementById("cancion").value.trim();
            const artista = document.getElementById("artista").value.trim();
            if (!nombre || !cancion || !artista) return alert("Completa todos los campos");
            db.ref("songs").push({ nombre, cancion, artista, tipo: "karaoke", mesa: "Online" });
            db.ref("visitantes/" + visitanteId).update({ habilitado: false });
        }
    </script>
</body>
</html>
